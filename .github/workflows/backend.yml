name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: yelbook-backend
  AWS_ACCOUNT_ID: '804257878061'

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.sha }}
      ec2_ip: ${{ steps.ec2.outputs.ip }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci --legacy-peer-deps

      - name: Lint (api)
        run: npx nx run api:lint

      - name: Typecheck (api)
        run: npx nx run api:typecheck

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            --build-arg AWS_REGION=${{ env.AWS_REGION }} \
            --build-arg AWS_ACCOUNT_ID=${{ env.AWS_ACCOUNT_ID }} \
            --build-arg NODE_ENV=production \
            --build-arg PORT=3001 \
            --build-arg HOST=0.0.0.0 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -f apps/api/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

      - name: Get EC2 instance IP
        id: ec2
        run: |
          INSTANCE_IP=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=yelbook-server" "Name=instance-state-name,Values=running" \
            --query 'Reservations[0].Instances[0].PublicIpAddress' \
            --output text)
          echo "ip=$INSTANCE_IP" >> $GITHUB_OUTPUT

  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ needs.build-and-push.outputs.ec2_ip }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
          script: |
            # Login to ECR
            aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com

            # Navigate to app directory
            cd /home/ec2-user/yelbook

            # Pull and restart only the api service
            docker compose pull api
            docker compose up -d api

            # Run database migrations
            docker compose exec -T api npx prisma migrate deploy --schema=prisma/schema.prisma || true

            # Cleanup old images
            docker image prune -f

  health-check:
    name: Health Check Report
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]

    steps:
      - name: Wait for service to start
        run: sleep 30

      - name: Health Check
        id: health
        run: |
          EC2_IP="${{ needs.build-and-push.outputs.ec2_ip }}"
          API_URL="http://${EC2_IP}:3001"

          echo "## Backend Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** ${API_URL}" >> $GITHUB_STEP_SUMMARY
          echo "**AWS Region:** ${{ env.AWS_REGION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check API health
          echo "### API Endpoint Check" >> $GITHUB_STEP_SUMMARY
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}/" || echo "000")

          if [ "$HTTP_STATUS" = "200" ]; then
            echo "| Endpoint | Status | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| GET / | ${HTTP_STATUS} | :white_check_mark: Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Endpoint | Status | Result |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| GET / | ${HTTP_STATUS} | :x: Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi

          # Check search endpoint
          SEARCH_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "${API_URL}/search" || echo "000")
          if [ "$SEARCH_STATUS" = "200" ]; then
            echo "| GET /search | ${SEARCH_STATUS} | :white_check_mark: Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GET /search | ${SEARCH_STATUS} | :x: Unhealthy |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Container Status" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "Image: ${{ env.AWS_ACCOUNT_ID }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

          # Fail if unhealthy
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "::error::API health check failed with status ${HTTP_STATUS}"
            exit 1
          fi
