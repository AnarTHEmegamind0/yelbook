name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'apps/api/**'
      - 'libs/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/backend.yml'
      - 'k8s/api/**'
      - 'k8s/jobs/**'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: yelbook-backend
  EKS_CLUSTER_NAME: yelbook-cluster
  K8S_NAMESPACE: yellowbooks
  NX_NO_CLOUD: true

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ github.sha }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install
        run: npm ci --legacy-peer-deps

      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: apps/api

      - name: Lint
        run: npx nx run api:lint
        env:
          NX_NO_CLOUD: true

      - name: Typecheck
        run: npx nx run api:typecheck
        env:
          NX_NO_CLOUD: true

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::804257878061:role/github-actions-eks-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build, tag, and push image to Amazon ECR
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build \
            --build-arg NODE_ENV=production \
            --build-arg PORT=3001 \
            --build-arg HOST=0.0.0.0 \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG \
            -t $ECR_REGISTRY/$ECR_REPOSITORY:latest \
            -f apps/api/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest

  deploy:
    name: Deploy to EKS
    runs-on: ubuntu-latest
    needs: build-and-push

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::804257878061:role/github-actions-eks-role
          aws-region: ${{ env.AWS_REGION }}

      - name: Update kubeconfig
        run: |
          aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }} --region ${{ env.AWS_REGION }}

      - name: Deploy to EKS
        env:
          IMAGE_TAG: ${{ github.sha }}
        run: |
          # Update image in deployment
          kubectl set image deployment/api \
            api=804257878061.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:$IMAGE_TAG \
            -n ${{ env.K8S_NAMESPACE }}

          # Wait for rollout to complete
          kubectl rollout status deployment/api -n ${{ env.K8S_NAMESPACE }} --timeout=300s

      - name: Run Migration Job
        run: |
          # Delete old job if exists
          kubectl delete job prisma-migration -n ${{ env.K8S_NAMESPACE }} --ignore-not-found

          # Update job image and apply
          sed -i 's|image:.*yelbook-backend:.*|image: 804257878061.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.ECR_REPOSITORY }}:${{ github.sha }}|' k8s/jobs/migration-job.yaml
          kubectl apply -f k8s/jobs/migration-job.yaml

          # Wait for completion
          kubectl wait --for=condition=complete job/prisma-migration -n ${{ env.K8S_NAMESPACE }} --timeout=120s || true

  health-check:
    name: Health Check
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy]

    steps:
      - name: Wait for deployment
        run: sleep 30

      - name: Health Check
        run: |
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 "https://yelbook.online/api" || echo "000")

          echo "## Backend Health Check Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Time:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Commit SHA:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**API URL:** https://yelbook.online/api" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### API Endpoint Check" >> $GITHUB_STEP_SUMMARY
          echo "| Endpoint | Status | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|--------|" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_STATUS" = "200" ] || [ "$HTTP_STATUS" = "304" ]; then
            echo "| GET /api | ${HTTP_STATUS} | :white_check_mark: Healthy |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GET /api | ${HTTP_STATUS} | :warning: Check Required |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "804257878061.dkr.ecr.us-east-1.amazonaws.com/yelbook-backend:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
